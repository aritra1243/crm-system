{% extends 'base.html' %}
{% block title %}Allocate Job - {{ job.job_id }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4"><i class="fas fa-user-plus text-success"></i> Allocate Job: {{ job.job_id }}</h2>
    </div>
  </div>

  <div class="row">
    <!-- Allocation Form -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <i class="fas fa-users"></i> Select Assignee
        </div>
        <div class="card-body">
          <form method="post" id="allocationForm">
            {% csrf_token %}
            <div class="mb-3">
              <label for="assigneeType" class="form-label">
                <strong><i class="fas fa-filter me-2"></i>Assign To:</strong>
              </label>
              <select name="assignee_type" id="assigneeType" class="form-select" required>
                <option value="">-- Select Assignment Type --</option>
                <option value="writer">Writer</option>
                <option value="process">Process User</option>
              </select>
              <small class="text-muted">Choose whether to assign to a Writer or Process user</small>
            </div>

            <!-- Second Dropdown -->
            <div class="mb-3" id="assigneeContainer" style="display: none;">
              <label for="assigneeId" class="form-label">
                <strong><i class="fas fa-user me-2"></i>Select <span id="assigneeLabel">Person</span>:</strong>
              </label>
              <select name="assignee_id" id="assigneeId" class="form-select" required disabled>
                <option value="">-- Loading... --</option>
              </select>
            </div>

            <!-- Spinner -->
            <div id="loadingSpinner" class="text-center my-3" style="display:none;">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-2 text-muted">Loading assignees...</p>
            </div>

            <!-- Alert -->
            <div id="alertContainer"></div>

            <div class="d-flex gap-2 mt-3">
              <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i> Cancel
              </a>
              <button type="submit" class="btn btn-success" id="submitBtn" disabled>
                <i class="fas fa-check me-1"></i> Allocate Job
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Job Summary -->
    <div class="col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <i class="fas fa-file-alt"></i> Job Summary
        </div>
        <div class="card-body">
          <p><strong>ID:</strong> {{ job.job_id }}</p>
          <p><strong>Word Count:</strong> {{ job.word_count }}</p>
          <p><strong>Amount:</strong> â‚¹{{ job.amount|default:0|floatformat:2 }}</p>
          <p><strong>Deadline:</strong> {{ job.expected_deadline|date:"M d, Y H:i" }}</p>
          <hr>
          {% if job.topic %}
            <p><strong>Topic:</strong> {{ job.topic }}</p>
          {% endif %}
          {% if job.instructions %}
            <p><strong>Instructions:</strong></p>
            <pre style="white-space: pre-wrap;">{{ job.instructions }}</pre>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const typeSelect = document.getElementById("assigneeType");
  const container = document.getElementById("assigneeContainer");
  const select = document.getElementById("assigneeId");
  const label = document.getElementById("assigneeLabel");
  const submitBtn = document.getElementById("submitBtn");
  const spinner = document.getElementById("loadingSpinner");
  const alertBox = document.getElementById("alertContainer");

  typeSelect.addEventListener("change", function() {
    const type = this.value;
    if (!type) {
      container.style.display = "none";
      select.disabled = true;
      submitBtn.disabled = true;
      return;
    }

    label.textContent = type === "writer" ? "Writer" : "Process User";
    spinner.style.display = "block";
    container.style.display = "none";
    submitBtn.disabled = true;

    fetch(`{% url 'allocate:get_assignees' %}?type=${type}`)
      .then(res => res.json())
      .then(data => {
        spinner.style.display = "none";
        if (data.error) {
          showAlert("Error loading assignees.", "danger");
          return;
        }

        select.innerHTML = `<option value="">-- Select ${label.textContent} --</option>`;
        data.assignees.forEach(a => {
          const opt = document.createElement("option");
          opt.value = a.id;
          opt.textContent = `${a.first_name} ${a.last_name} (${a.email})`;
          select.appendChild(opt);
        });
        container.style.display = "block";
        select.disabled = false;
      })
      .catch(() => {
        spinner.style.display = "none";
        showAlert("Failed to load assignees.", "danger");
      });
  });

  select.addEventListener("change", function() {
    submitBtn.disabled = !this.value;
  });

  function showAlert(message, type) {
    alertBox.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>`;
  }
});
</script>
{% endblock %}
