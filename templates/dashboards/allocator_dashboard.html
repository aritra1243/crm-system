{% extends 'base.html' %}
{% block title %}Allocator Dashboard{% endblock %}
{% block content %}

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body text-center">
                <i class="fas fa-inbox fa-3x mb-2"></i>
                <h3 class="mb-0">{{ stats.pending_count }}</h3>
                <p class="mb-0">Pending Allocation</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="card-body text-center">
                <i class="fas fa-check-double fa-3x mb-2"></i>
                <h3 class="mb-0">{{ stats.allocated_today }}</h3>
                <p class="mb-0">Allocated Today</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="card-body text-center">
                <i class="fas fa-user-friends fa-3x mb-2"></i>
                <h3 class="mb-0">{{ stats.active_writers }}</h3>
                <p class="mb-0">Active Writers</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
            <div class="card-body text-center">
                <i class="fas fa-exclamation-triangle fa-3x mb-2"></i>
                <h3 class="mb-0">{{ stats.overdue_count }}</h3>
                <p class="mb-0">Overdue Tasks</p>
            </div>
        </div>
    </div>
</div>

<!-- Pending Jobs Section -->
{% if pending_jobs %}
<div class="card shadow-sm mb-4">
    <div class="card-header text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <h5 class="mb-0">
            <i class="fas fa-clock me-2"></i>Jobs Pending Allocation 
            <span class="badge bg-white text-dark ms-2">{{ stats.pending_count }}</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Review and allocate jobs to writers or process users below.
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th><i class="fas fa-hashtag me-1"></i>Job ID</th>
                        <th><i class="fas fa-heading me-1"></i>Topic</th>
                        <th><i class="fas fa-sort-numeric-up me-1"></i>Words</th>
                        <th><i class="fas fa-rupee-sign me-1"></i>Amount</th>
                        <th><i class="fas fa-calendar-alt me-1"></i>Expected Deadline</th>
                        <th><i class="fas fa-exclamation-triangle me-1"></i>Strict Deadline</th>
                        <th><i class="fas fa-user me-1"></i>Created By</th>
                        <th><i class="fas fa-cogs me-1"></i>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in pending_jobs %}
                    <tr>
                        <td><strong class="text-primary">{{ job.job_id }}</strong></td>
                        <td>{{ job.topic|default:"N/A"|truncatewords:5 }}</td>
                        <td>{{ job.word_count|default:"N/A" }}</td>
                        <td>₹{{ job.amount|default:0|floatformat:2 }}</td>
                        <td><small class="text-info">{{ job.expected_deadline|date:"M d, Y H:i" }}</small></td>
                        <td><small class="text-danger">{{ job.strict_deadline|date:"M d, Y H:i" }}</small></td>
                        <td>{{ job.created_by.first_name }} {{ job.created_by.last_name }}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-info me-1" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#viewJobModal{{ job.pk }}">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button type="button" class="btn btn-sm btn-success" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#allocateModal{{ job.pk }}">
                                <i class="fas fa-user-plus"></i> Allocate
                            </button>
                        </td>
                    </tr>

                    <!-- View Job Details Modal -->
                    <div class="modal fade" id="viewJobModal{{ job.pk }}" tabindex="-1" aria-labelledby="viewJobModalLabel{{ job.pk }}" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-info text-white">
                                    <h5 class="modal-title" id="viewJobModalLabel{{ job.pk }}">
                                        <i class="fas fa-file-alt me-2"></i>Job Details: {{ job.job_id }}
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <strong><i class="fas fa-hashtag me-2"></i>Job ID:</strong>
                                            <p>{{ job.job_id }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <strong><i class="fas fa-user me-2"></i>Created By:</strong>
                                            <p>{{ job.created_by.first_name }} {{ job.created_by.last_name }}</p>
                                        </div>
                                    </div>

                                    {% if job.topic %}
                                    <div class="mb-3">
                                        <strong><i class="fas fa-heading me-2"></i>Topic:</strong>
                                        <div class="border p-2 bg-light">{{ job.topic }}</div>
                                    </div>
                                    {% endif %}

                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <strong><i class="fas fa-sort-numeric-up me-2"></i>Word Count:</strong>
                                            <p>{{ job.word_count|default:"N/A" }}</p>
                                        </div>
                                        <div class="col-md-4">
                                            <strong><i class="fas fa-book me-2"></i>Referencing:</strong>
                                            <p>{{ job.get_referencing_style_display|default:"N/A" }}</p>
                                        </div>
                                        <div class="col-md-4">
                                            <strong><i class="fas fa-pen-fancy me-2"></i>Writing Style:</strong>
                                            <p>{{ job.get_writing_style_display|default:"N/A" }}</p>
                                        </div>
                                    </div>

                                    {% if job.instructions %}
                                    <div class="mb-3">
                                        <strong><i class="fas fa-align-left me-2"></i>Instructions:</strong>
                                        <pre class="border p-3 bg-light" style="white-space: pre-wrap;">{{ job.instructions }}</pre>
                                    </div>
                                    {% endif %}

                                    {% if job.completion_instructions %}
                                    <div class="mb-3">
                                        <strong><i class="fas fa-clipboard-list me-2"></i>Completion Instructions:</strong>
                                        <pre class="border p-3 bg-light" style="white-space: pre-wrap;">{{ job.completion_instructions }}</pre>
                                    </div>
                                    {% endif %}

                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <strong><i class="fas fa-calendar-alt me-2"></i>Expected Deadline:</strong>
                                            <p class="text-info">{{ job.expected_deadline|date:"F d, Y H:i" }}</p>
                                        </div>
                                        <div class="col-md-4">
                                            <strong><i class="fas fa-exclamation-triangle me-2"></i>Strict Deadline:</strong>
                                            <p class="text-danger">{{ job.strict_deadline|date:"F d, Y H:i" }}</p>
                                        </div>
                                        <div class="col-md-4">
                                            <strong><i class="fas fa-rupee-sign me-2"></i>Amount:</strong>
                                            <p class="text-success">₹{{ job.amount|default:0|floatformat:2 }}</p>
                                        </div>
                                    </div>

                                    {% if job.attachment %}
                                    <div class="mb-3">
                                        <strong><i class="fas fa-paperclip me-2"></i>Attachment:</strong>
                                        <a href="{{ job.attachment.url }}" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="fas fa-download me-1"></i>Download
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-success" 
                                            data-bs-dismiss="modal" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#allocateModal{{ job.pk }}">
                                        <i class="fas fa-user-plus me-1"></i>Allocate This Job
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Allocate Job Modal -->
                    <div class="modal fade" id="allocateModal{{ job.pk }}" tabindex="-1" aria-labelledby="allocateModalLabel{{ job.pk }}" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title" id="allocateModalLabel{{ job.pk }}">
                                        <i class="fas fa-user-plus me-2"></i>Allocate Job: {{ job.job_id }}
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form method="post" action="{% if job.pk %}{% url 'allocate:allocate_job' job.pk %}{% else %}#{% endif %}" id="allocateForm{{ job.pk|default:job.job_id }}">

                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <!-- Job Summary -->
                                        <div class="alert alert-light border">
                                            <strong>Job Summary:</strong>
                                            <ul class="mb-0 mt-2">
                                                <li><strong>ID:</strong> {{ job.job_id }}</li>
                                                <li><strong>Word Count:</strong> {{ job.word_count }}</li>
                                                <li><strong>Amount:</strong> ₹{{ job.amount|default:0|floatformat:2 }}</li>
                                                <li><strong>Deadline:</strong> {{ job.expected_deadline|date:"M d, Y H:i" }}</li>
                                            </ul>
                                        </div>

                                        <!-- Assignment Type Dropdown -->
                                        <div class="mb-3">
                                            <label class="form-label" for="assigneeType{{ job.pk }}">
                                                <strong><i class="fas fa-filter me-2"></i>Assign To:</strong>
                                            </label>
                                            <select name="assignee_type" 
                                                    id="assigneeType{{ job.pk }}" 
                                                    class="form-select" 
                                                    required>
                                                <option value="">-- Select Type --</option>
                                                <option value="writer">Writer</option>
                                                <option value="process">Process User</option>
                                            </select>
                                            <small class="text-muted">Choose assignment type</small>
                                        </div>

                                        <!-- Assignee Dropdown (populated dynamically) -->
                                        <div class="mb-3" id="assigneeContainer{{ job.pk }}" style="display: none;">
                                            <label class="form-label" for="assigneeSelect{{ job.pk }}">
                                                <strong><i class="fas fa-user me-2"></i>Select <span id="assigneeLabel{{ job.pk }}">Person</span>:</strong>
                                            </label>
                                            <select name="assignee_id" 
                                                    id="assigneeSelect{{ job.pk }}" 
                                                    class="form-select" 
                                                    required 
                                                    disabled>
                                                <option value="">-- Loading... --</option>
                                            </select>
                                            <small class="text-muted">Select the person to assign</small>
                                        </div>

                                        <!-- Loading Spinner -->
                                        <div id="loadingSpinner{{ job.pk }}" class="text-center my-3" style="display: none;">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="mt-2 text-muted">Loading assignees...</p>
                                        </div>

                                        <!-- Info Alert -->
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Choose either a Writer or a Process user to allocate this job.
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="submit" 
                                                class="btn btn-success" 
                                                id="submitBtn{{ job.pk }}" 
                                                disabled>
                                            <i class="fas fa-check me-1"></i>Allocate Job
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-success">
    <i class="fas fa-check-circle me-2"></i>
    <strong>All caught up!</strong> No jobs pending allocation at the moment.
</div>
{% endif %}

<!-- Allocated Jobs Section -->
{% if allocated_jobs %}
<div class="card shadow-sm mb-4">
    <div class="card-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5 class="mb-0">
            <i class="fas fa-tasks me-2"></i>Currently Allocated Jobs
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Job ID</th>
                        <th>Assignee</th>
                        <th>Role</th>
                        <th>Word Count</th>
                        <th>Amount</th>
                        <th>Allocated Date</th>
                        <th>Deadline</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in allocated_jobs %}
                    <tr{% if job.expected_deadline < now %} class="table-danger"{% endif %}>
                        <td><strong>{{ job.job_id }}</strong></td>
                        <td>{{ job.allocated_to.first_name }} {{ job.allocated_to.last_name }}</td>
                        <td>
                            {% if job.allocated_to.role == 'writer' %}
                            <span class="badge bg-primary">Writer</span>
                            {% else %}
                            <span class="badge bg-info">Process</span>
                            {% endif %}
                        </td>
                        <td>{{ job.word_count }}</td>
                        <td>₹{{ job.amount|default:0|floatformat:2 }}</td>
                        <td><small>{{ job.allocated_at|date:"M d, Y H:i" }}</small></td>
                        <td>
                            <small{% if job.expected_deadline < now %} class="text-danger fw-bold"{% endif %}>
                                {{ job.expected_deadline|date:"M d, Y H:i" }}
                            </small>
                        </td>
                        <td>
                            {% if job.status == 'allocated' %}
                            <span class="badge bg-info"><i class="fas fa-clock me-1"></i>Allocated</span>
                            {% elif job.status == 'in_progress' %}
                            <span class="badge bg-warning"><i class="fas fa-spinner me-1"></i>In Progress</span>
                            {% elif job.status == 'submitted' %}
                            <span class="badge bg-primary"><i class="fas fa-paper-plane me-1"></i>Submitted</span>
                            {% elif job.status == 'completed' %}
                            <span class="badge bg-success"><i class="fas fa-check me-1"></i>Completed</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ job.get_status_display }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Completed Jobs Section -->
{% if completed_jobs %}
<div class="card shadow-sm">
    <div class="card-header text-white" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
        <h5 class="mb-0">
            <i class="fas fa-check-circle me-2"></i>Recently Completed Jobs
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Job ID</th>
                        <th>Completed By</th>
                        <th>Word Count</th>
                        <th>Amount</th>
                        <th>Completion Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in completed_jobs %}
                    <tr>
                        <td><strong>{{ job.job_id }}</strong></td>
                        <td>{{ job.allocated_to.first_name }} {{ job.allocated_to.last_name }}</td>
                        <td>{{ job.word_count }}</td>
                        <td>₹{{ job.amount|default:0|floatformat:2 }}</td>
                        <td><small>{{ job.updated_at|date:"M d, Y H:i" }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    var forms = document.querySelectorAll('form[id^="allocateForm"]');
    forms.forEach(function(form) {
        var submitBtn = form.querySelector('.allocate-submit');
        var typeSelect = form.querySelector('.assignee-type-select');
        var writerSelect = form.querySelector('.writer-select');
        var processSelect = form.querySelector('.process-select');
        var writerGroup = form.querySelector('.assignee-writer-group');
        var processGroup = form.querySelector('.assignee-process-group');

        if (!submitBtn) {
            return;
        }

        function syncGroupVisibility(groupEl, selectEl, shouldShow) {
            if (!groupEl || !selectEl) {
                return;
            }
            if (shouldShow) {
                groupEl.classList.remove('d-none');
                groupEl.style.display = 'block';
                selectEl.disabled = false;
                selectEl.required = true;
            } else {
                groupEl.classList.add('d-none');
                groupEl.style.display = 'none';
                selectEl.disabled = true;
                selectEl.required = false;
                selectEl.value = '';
            }
        }

        function toggleSubmit() {
            var hasSelection = false;
            if (typeSelect && typeSelect.value === 'writer') {
                hasSelection = writerSelect && writerSelect.value;
            } else if (typeSelect && typeSelect.value === 'process') {
                hasSelection = processSelect && processSelect.value;
            }
            submitBtn.disabled = !hasSelection;
        }

        function showGroup(type) {
            syncGroupVisibility(writerGroup, writerSelect, type === 'writer');
            syncGroupVisibility(processGroup, processSelect, type === 'process');
            toggleSubmit();
        }

        if (typeSelect) {
            typeSelect.addEventListener('change', function(e) {
                showGroup(e.target.value);
            });
            typeSelect.value = '';
        }

        if (writerSelect) {
            writerSelect.addEventListener('change', toggleSubmit);
        }
        if (processSelect) {
            processSelect.addEventListener('change', toggleSubmit);
        }

        var modalElement = form.closest('.modal');
        if (modalElement) {
            modalElement.addEventListener('hidden.bs.modal', function() {
                if (typeSelect) {
                    typeSelect.value = '';
                }
                showGroup('');
            });
            modalElement.addEventListener('shown.bs.modal', function() {
                showGroup(typeSelect ? typeSelect.value : '');
            });
        }

        showGroup('');
    });
});
</script>

{% endblock %}