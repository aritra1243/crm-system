{% extends 'base.html' %}

{% block title %}Writer Dashboard{% endblock %}

{% block content %}
<style>
    .blurred {
        filter: blur(3px);
        pointer-events: none;
        user-select: none;
        position: relative;
    }
    .blurred::after {
        content: "Complete current job to unlock";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.6);
        color: #fff;
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 0.9rem;
    }
</style>

<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-pen text-success"></i> Writer Dashboard
        </h2>
    </div>
</div>

<div class="row">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-file-alt fa-2x mb-2"></i>
                <h3>{{ stats.assigned_count }}</h3>
                <p class="mb-0">Assigned Jobs</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <h3>{{ stats.in_progress }}</h3>
                <p class="mb-0">In Progress</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h3>{{ stats.completed }}</h3>
                <p class="mb-0">Completed</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-star fa-2x mb-2"></i>
                <h3>{{ stats.rating }}</h3>
                <p class="mb-0">Rating</p>
            </div>
        </div>
    </div>
</div>

{% if visible_job %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <i class="fas fa-unlock"></i> Current Job
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Job ID:</strong> {{ visible_job.job_id }}
                    </div>
                    <div class="col-md-4">
                        <strong>Deadline:</strong> {{ visible_job.expected_deadline|date:"M d, Y H:i" }}
                    </div>
                    <div class="col-md-4">
                        <strong>Status:</strong>
                        <span class="badge {% if visible_job.status == 'allocated' %}bg-info{% elif visible_job.status == 'in_progress' %}bg-warning{% elif visible_job.status == 'submitted' %}bg-success{% else %}bg-secondary{% endif %}">
                            {{ visible_job.get_status_display }}
                        </span>
                    </div>
                </div>

                {% if visible_job.topic %}
                <div class="mb-3">
                    <strong>Title / Topic:</strong>
                    <div class="border p-2 bg-light">{{ visible_job.topic }}</div>
                </div>
                {% endif %}

                <div class="row mb-3">
                    <div class="col-md-3">
                        <strong>Word Count:</strong> {{ visible_job.word_count|default:"N/A" }}
                    </div>
                    <div class="col-md-3">
                        <strong>Referencing:</strong> {{ visible_job.get_referencing_style_display|default:"N/A" }}
                    </div>
                    <div class="col-md-3">
                        <strong>Writing Style:</strong> {{ visible_job.get_writing_style_display|default:"N/A" }}
                    </div>
                    <div class="col-md-3">
                        <strong>Amount:</strong> â‚¹{{ visible_job.amount|default:"0"|floatformat:2 }}
                    </div>
                </div>

                <div class="mb-3">
                    <strong>Initial Instructions:</strong>
                    <pre class="border p-3 bg-light" style="white-space: pre-wrap;">{{ visible_job.instructions }}</pre>
                </div>

                {% if visible_job.completion_instructions %}
                <div class="mb-3">
                    <strong>Completion Instructions:</strong>
                    <pre class="border p-3 bg-light" style="white-space: pre-wrap;">{{ visible_job.completion_instructions }}</pre>
                </div>
                {% endif %}

                <div class="d-flex flex-wrap gap-2">
                    {% if visible_job.status == 'allocated' %}
                    <a href="{% url 'writer_start' visible_job.job_id %}" class="btn btn-primary">
                        <i class="fas fa-play"></i> Start Job
                    </a>
                    {% endif %}

                    {% if visible_job.status in 'allocated,in_progress' or visible_job.status == 'in_progress' %}
                    <a href="{% url 'writer_upload_structure' visible_job.job_id %}" class="btn btn-warning">
                        <i class="fas fa-sitemap"></i> Upload Structure
                    </a>
                    <a href="{% url 'writer_upload_final' visible_job.job_id %}" class="btn btn-success">
                        <i class="fas fa-upload"></i> Upload Final + Summary
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> No active job to work on. If you have multiple assigned jobs, you may have already submitted the current one. Wait for the next to unlock.
        </div>
    </div>
</div>
{% endif %}

{% if blurred_jobs %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-secondary">
            <div class="card-header">
                <i class="fas fa-lock"></i> Upcoming Jobs (blurred until you submit the current job)
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% for job in blurred_jobs %}
                    <div class="col-md-4">
                        <div class="card blurred">
                            <div class="card-body">
                                <h5 class="card-title">{{ job.job_id }}</h5>
                                <p class="card-text">{{ job.topic|default:"No topic"|truncatewords:10 }}</p>
                                <p class="mb-1"><strong>Deadline:</strong> {{ job.expected_deadline|date:"M d, Y H:i" }}</p>
                                <span class="badge {% if job.status == 'allocated' %}bg-info{% elif job.status == 'in_progress' %}bg-warning{% elif job.status == 'submitted' %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ job.get_status_display }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12 text-muted">No more jobs.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
